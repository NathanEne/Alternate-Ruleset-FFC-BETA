install.packages("rmarkdown")
install.packages('smoother')
devtools::install_github("thomasp85/patchwork")
library(patchwork)


```{r}
#defining the function that will plot the metrics 
comparison_violin_plot_print<- function(metrics_1, metrics_2,stream_class,data_title){
  
  lable_df <- read.csv("./Post_Processing_Files/Box_plot_lables.csv",header = T)
  
  lable_df <- lable_df[1:24,]
  
  cnames <- colnames(metrics_1)
  
  for (col in cnames[2:length(cnames)-1]) {
    #Check to see if the entire column are NA or NAN values
    if (all(is.na(metrics_1[[col]]) | is.nan(metrics_1[[col]]))) {
      # Set all values in the column to 0
      metrics_1[[col]] <- 0
    }
    
    # Replace negative numbers with NA in metrics_1
    metrics_1[[col]][metrics_1[[col]] < 0] <- NA
    
    #Move data from the dataframe to the placeholder list
    placeholder1 <- metrics_1[col]
    
    
    #Check to see if the entire column are NA or NAN values
    if (all(is.na(metrics_2[[col]]) | is.nan(metrics_2[[col]]))) {
      # Set all values in the column to 0
      metrics_2[[col]] <- 0
    }
    
    # Replace negative numbers with NA
    metrics_2[[col]][metrics_2[[col]] < 0] <- NA
    
    placeholder2 <- metrics_2[col]
  
    
    col_index <- which(lable_df$Flow.Metric.Code==col)
    
    #cat(col)
    
    Violinplot <- ggplot() +
      geom_violin(aes(x = "FFC metrics", y = as.numeric(unlist(placeholder1))), fill = "green") +
      geom_boxplot(aes(x = "FFC metrics", y = as.numeric(unlist(placeholder1))), color = "darkgreen", alpha = 0.6) +
      geom_violin(aes(x = "BFFC metrics", y = as.numeric(unlist(placeholder2))), fill = 'blue') +
      geom_boxplot(aes(x = "BFFC metrics", y = as.numeric(unlist(placeholder2))), color = "darkblue", alpha = 0.6)
      
      Violinplot <- Violinplot +
      labs(x = "Flow Regimes", y = lable_df$Unit[col_index], title = paste(data_title, "-", lable_df$Flow.Metric.Name[col_index]))
    
    plot(Violinplot)

    ggsave(paste0("~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Alternate-Ruleset-FFC-BETA/Report Figures","/",stream_class,"/",lable_df$Flow.Metric.Name[col_index],".png"), plot = Violinplot, device = "png")
  }
}
```

Spring recession start finding figure
```{r}
# Figure for showing spring recession start

#load in the flow 
flow_g_11172945 <- read.csv("~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Class 7  Reference Gages/11172945/11172945_flow.csv", header = T) %>%
  mutate(date = as.Date(date, "%m/%d/%Y"))

 #Format the data for the calculator 
  FlowYear <- attach_water_year_data(flow_g_11172945, date_field = "date")
  

  fig_flow <- filter(FlowYear, water_year == 2016)
  
  if (!require(gridExtra)) {
  install.packages("gridExtra")
  library(gridExtra)
  }
  x <- seq(1,366,1)
 #Filter the flow to remove the noise on the rising limb
  window <- 4
  alpha <- 1.3
  filter_flow <- smth.gaussian(fig_flow$flow,window = window, alpha = alpha, tails = TRUE)
      
#Calculate the peaks that occur throughout the year
  peaks <- as.data.frame(findpeaks(filter_flow),threshold = min((0.15*WY_median),15))
      
  #We also want to consider peaks that are flat the limit was set as 3 "flat" points for these
  peaks_2 <- as.data.frame(findpeaks(filter_flow, peakpat = "[+]{1,}[0]{1,3}[-]{1,}"),threshold = min((0.15*WY_median),15))
      
  #combine the two data sets of peaks
  peaks_all <- bind_rows(peaks,peaks_2)
      
  peak_dates <- peaks_all %>%  #Update the name of the data from
    mutate(peak_date = as.Date(paste(V2, 2016), '%j %Y')-92) #Date in Julian days
      
  fig_quants <- quantile(fig_flow$flow, probs = c(0.5, 0.9),na.rm = TRUE, names = FALSE)
      
  thresh <- rep(fig_quants[2],length(fig_flow$date))
      
  
  fig_peaks_90 <- dplyr::filter(peaks_all, peaks_all$V1 > fig_quants[2])
  fig_peaks_90 <- dplyr::filter(fig_peaks_90, fig_peaks_90$V2 <345)
  
  PH1_start <- tail(fig_peaks_90[,2],1)
  PH1_poten <- seq(PH1_start - 2, PH1_start + 2, by = 1)
  max_flow_check <- which(fig_flow$flow[PH1_poten]==max(fig_flow$flow[PH1_poten]))[length(which(fig_flow$flow[PH1_poten]==max(fig_flow$flow[PH1_poten])))]
  springindex_PH1 <- tail(fig_peaks_90[,2],1)-5+max_flow_check
  
  flow_df <- data_frame(x,fig_flow, thresh)
      
  flow_df  <- flow_df %>% 
    left_join(dplyr::select(peaks_all, V2, V1), by = c("x" = "V2"))
      
    
    #Assign the last peak of the year as the first potential spring timing
  PH1_start <- tail(fig_peaks_90[,2],1)
  PH1_poten <- seq(PH1_start - 2, PH1_start + 2, by = 1)
  max_flow_check <- which(flow$flow[PH1_poten]==max(flow$flow[PH1_poten]))[length(which(flow$flow[PH1_poten]==max(flow$flow[PH1_poten])))]
  springindex_PH1 <- tail(fig_peaks_90[,2],1)-5+max_flow_check
  
  SP_met <- data.frame(SP_tim = springindex_PH1,SP_Mag = fig_flow$flow[springindex_PH1])
    
  flow_df  <- flow_df %>% 
    left_join(dplyr::select(SP_met, SP_Mag, SP_tim), by = c("x" = "SP_tim"))
  
# Create ggplot objects for each sub-figure
plot1 <- ggplot(data.frame(x, fig_flow$flow), aes(x, fig_flow$flow)) + geom_line(color = "black") + ggtitle("Flow Year")+
  #scale_color_manual(values = c("black"))+
  labs(x = "Day of Water Year", y = "Flow (cfs)")+
  ggtitle("Step 1: Filter Flow Data to Single Water Year")+
  #theme_minimal() +
  theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "cm"))  # Adjust height as needed

plot2 <- ggplot(data.frame(x, fig_flow$flow,filter_flow), aes(x)) + geom_line(aes(y = fig_flow$flow, color = "Raw Flow Data"))+geom_line(aes(y = filter_flow, color = "Smoothed FLow Data")) +
  ggtitle("Flow smoothed using narrow Gaussian filter")+
  scale_color_manual(values = c("black", "blue"))+
  annotate("text", x = 50, y = max(fig_flow$flow)+30,hjust=.2, label = "Gaussian filter with window of 4 days and alpha of 1.3")+
  labs(x = "Day of Water Year", y = "Flow (cfs)")+
  ggtitle("Step 2: Smooth Flow Data ")+
  #theme_minimal() +
  theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "cm"))  # Adjust height as needed

plot3 <- ggplot(data.frame(flow_df), aes(x)) + geom_line(aes(y = fig_flow$flow, color = "Raw Flow Data"))+
  geom_line(aes(y = filter_flow, color = "Smoothed FLow Data")) +
  geom_point(aes( y = V1, color = "Identified Peaks"), shape = 1,size = 1.5) +
  geom_line(aes(y = thresh, color = "Minimum Threshold for Spring \n Recession Start (90th percentile of flow)"))+ 
  ggtitle("Step 3: Finding Peaks and Setting Minimum Thershold")+
  scale_color_manual(values = c("red", "green","black", "blue"))+
  labs(x = "Day of Water Year", y = "Flow (cfs)")+
  annotate("text", x = 50, y = max(fig_flow$flow)+30,hjust=.2, label = "Peaks found across the water year")+
  #theme_minimal() +
  theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "cm"))  # Adjust height as needed
  
plot4 <- ggplot(data.frame(flow_df), aes(x)) + geom_line(aes(y = fig_flow$flow, color = "Raw Flow Data"))+
  geom_point(aes( y = SP_Mag, color = "Spring Recession Start"), shape = 1,size = 1.5) +
  ggtitle("Step 4: Final Spring Recession Start Timing Found")+
  scale_color_manual(values = c("black", "green"))+
  labs(x = "Day of Water Year", y = "Flow (cfs)")+
  annotate("text", x = 4, y = 0.8, label = "Last qulified peak found and then translated back to original flow data.")+
  #theme_minimal() +
  theme(plot.margin = unit(c(0.5, 0.5, 0.5, 0.5), "cm"))  # Adjust height as needed

# Arrange ggplot objects in a 2x2 grid
#test_fig <- grid.arrange(plot1, plot2, plot3, plot4, ncol = 2)

#print(test_fig)

# Arrange ggplot objects using patchwork
arranged_plots <- plot1 / plot2 / plot3 / plot4 / plot_layout(ncol = 1, widths = 20, heights = 40)

# Print the arranged plots
arranged_plots


ggsave(paste0("~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Alternate-Ruleset-FFC-BETA/Report Figures","/Spring Recession Start Timing.png"), plot = arranged_plots, dpi = 300, device = "png")
ggsave(paste0("~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Alternate-Ruleset-FFC-BETA/Report Figures","/Spring Recession Start Timing_ step 1.png"), plot = plot1, device = "png")
ggsave(paste0("~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Alternate-Ruleset-FFC-BETA/Report Figures","/Spring Recession Start Timing_ step 2.png"), plot = plot2, device = "png")
ggsave(paste0("~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Alternate-Ruleset-FFC-BETA/Report Figures","/Spring Recession Start Timing_ step 3.png"), plot = plot3, device = "png")
ggsave(paste0("~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Alternate-Ruleset-FFC-BETA/Report Figures","/Spring Recession Start Timing_ step 4.png"), plot = plot4, device = "png")
```
flow_g_11172945 <- read_csv("~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Class 7  Reference Gages/11172945/11172945_flow.csv", header = T)

plot1 + plot2


Make the figures for Class 1

```{r}
#make the figures for class 1

# Function to read CSV files into a list of data frames
read_csv_files <- function(files) {
  lapply(files, function(file) {
    read.csv(file)
  })
}

# Read files ending with "_Original Calculator_Metrics.csv"
files_original_ffc <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Updated Reference Gages Class 1", pattern = "_Original Calculator_Metrics.csv$", recursive = TRUE, full.names = TRUE)

# Read files ending with "_Metrics.csv"
files_metrics_bffc <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Updated Reference Gages Class 1", pattern = "_Metrics.csv$", recursive = TRUE, full.names = TRUE)

#Since both character list have the ffc metrics since they have the same pattern
BFFC_metrics_list <- files_metrics_bffc[!files_metrics_bffc %in% files_original_ffc]

#Now we can read in all of the csv's files
#first with the BFFC
BFFC_metrics_dfs <- read_csv_files(BFFC_metrics_list)

BFFC_metrics <- do.call(rbind, BFFC_metrics_dfs)

#Second with ffc metrics
FFC_metrics_dfs <- read_csv_files(files_original_ffc)

FFC_metrics <- do.call(rbind, FFC_metrics_dfs)

#Now cycle through the names in the dataframes and make comaring viollin plots
cnames <- colnames(FFC_metrics)

comparison_violin_plot_print(metrics_1 = FFC_metrics, metrics_2 = BFFC_metrics, stream_class = "Class 1", data_title = "Class 1 metric comparison")
```


Make the figures for Class 2

```{r}
#make the figures for class 2

# Function to read CSV files into a list of data frames
read_csv_files <- function(files) {
  lapply(files, function(file) {
    read.csv(file)
  })
}

# Read files ending with "_Original Calculator_Metrics.csv"
files_original_ffc <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Updated Reference Gages Class 2", pattern = "_Original Calculator_Metrics.csv$", recursive = TRUE, full.names = TRUE)

# Read files ending with "_Metrics.csv"
files_metrics_bffc <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Updated Reference Gages Class 2", pattern = "_Metrics.csv$", recursive = TRUE, full.names = TRUE)

#Since both character list have the ffc metrics since they have the same pattern
BFFC_metrics_list <- files_metrics_bffc[!files_metrics_bffc %in% files_original_ffc]

#Now we can read in all of the csv's files
#first with the BFFC
BFFC_metrics_dfs <- read_csv_files(BFFC_metrics_list)

BFFC_metrics <- do.call(rbind, BFFC_metrics_dfs)

#Second with ffc metrics
FFC_metrics_dfs <- read_csv_files(files_original_ffc)

FFC_metrics <- do.call(rbind, FFC_metrics_dfs)

#Now cycle through the names in the dataframes and make comaring viollin plots
cnames <- colnames(FFC_metrics)

comparison_violin_plot_print(metrics_1 = FFC_metrics, metrics_2 = BFFC_metrics, stream_class = "Class 2", data_title = "Class 2 metric comparison")
```



Make the figures for Class 3

```{r}
#make the figures for class 3

# Function to read CSV files into a list of data frames
read_csv_files <- function(files) {
  lapply(files, function(file) {
    read.csv(file)
  })
}

# Read files ending with "_Original Calculator_Metrics.csv"
files_original_ffc <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Updated Reference Gages Class 3", pattern = "_Original Calculator_Metrics.csv$", recursive = TRUE, full.names = TRUE)

# Read files ending with "_Metrics.csv"
files_metrics_bffc <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Updated Reference Gages Class 3", pattern = "_Metrics.csv$", recursive = TRUE, full.names = TRUE)

#Since both character list have the ffc metrics since they have the same pattern
BFFC_metrics_list <- files_metrics_bffc[!files_metrics_bffc %in% files_original_ffc]

#Now we can read in all of the csv's files
#first with the BFFC
BFFC_metrics_dfs <- read_csv_files(BFFC_metrics_list)

BFFC_metrics <- do.call(rbind, BFFC_metrics_dfs)

#Second with ffc metrics
FFC_metrics_dfs <- read_csv_files(files_original_ffc)

FFC_metrics <- do.call(rbind, FFC_metrics_dfs)

#Now cycle through the names in the dataframes and make comaring viollin plots
cnames <- colnames(FFC_metrics)

comparison_violin_plot_print(metrics_1 = FFC_metrics, metrics_2 = BFFC_metrics, stream_class = "Class 3", data_title = "Class 3 metric comparison")
```

Make the figures for Class 4

```{r}
#make the figures for class 4

# Function to read CSV files into a list of data frames
read_csv_files <- function(files) {
  lapply(files, function(file) {
    read.csv(file)
  })
}

# Read files ending with "_Original Calculator_Metrics.csv"
files_original_ffc <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Updated Reference Gages Class 4", pattern = "_Original Calculator_Metrics.csv$", recursive = TRUE, full.names = TRUE)

# Read files ending with "_Metrics.csv"
files_metrics_bffc <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Updated Reference Gages Class 4", pattern = "_Metrics.csv$", recursive = TRUE, full.names = TRUE)

#Since both character list have the ffc metrics since they have the same pattern
BFFC_metrics_list <- files_metrics_bffc[!files_metrics_bffc %in% files_original_ffc]

#Now we can read in all of the csv's files
#first with the BFFC
BFFC_metrics_dfs <- read_csv_files(BFFC_metrics_list)

BFFC_metrics <- do.call(rbind, BFFC_metrics_dfs)

#Second with ffc metrics
FFC_metrics_dfs <- read_csv_files(files_original_ffc)

FFC_metrics <- do.call(rbind, FFC_metrics_dfs)

#Now cycle through the names in the dataframes and make comaring viollin plots
cnames <- colnames(FFC_metrics)

comparison_violin_plot_print(metrics_1 = FFC_metrics, metrics_2 = BFFC_metrics, stream_class = "Class 4", data_title = "Class 4 metric comparison")
```



Make the figures for Class 5

```{r}
#make the figures for class 5

# Read files ending with "_Original Calculator_Metrics.csv"
files_original_ffc <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Updated Reference Gages Class 5 11377100", pattern = "_Original Calculator_Metrics.csv$", recursive = TRUE, full.names = TRUE)

# Read files ending with "_Metrics.csv"
files_metrics_bffc <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Updated Reference Gages Class 5 11377100", pattern = "_Metrics.csv$", recursive = TRUE, full.names = TRUE)

#Since both character list have the ffc metrics since they have the same pattern
BFFC_metrics_list <- files_metrics_bffc[!files_metrics_bffc %in% files_original_ffc]

#Now we can read in all of the csv's files
#first with the BFFC
BFFC_metrics_dfs <- read_csv_files(BFFC_metrics_list)

BFFC_metrics <- do.call(rbind, BFFC_metrics_dfs)

#Second with ffc metrics
FFC_metrics_dfs <- read_csv_files(files_original_ffc)

FFC_metrics <- do.call(rbind, FFC_metrics_dfs)

#Now cycle through the names in the dataframes and make comaring viollin plots
cnames <- colnames(FFC_metrics)

comparison_violin_plot_print(metrics_1 = FFC_metrics, metrics_2 = BFFC_metrics, stream_class = "Class 5", data_title = "Class 5 metric comparison")
```



Make the figures for Class 6

```{r}

# Read files ending with "_Original Calculator_Metrics.csv"
files_original_ffc <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Updated Reference Gages Class 6", pattern = "_Original Calculator_Metrics.csv$", recursive = TRUE, full.names = TRUE)

# Read files ending with "_Metrics.csv"
files_metrics_bffc <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Updated Reference Gages Class 6", pattern = "_Metrics.csv$", recursive = TRUE, full.names = TRUE)

#Since both character list have the ffc metrics since they have the same pattern
BFFC_metrics_list <- files_metrics_bffc[!files_metrics_bffc %in% files_original_ffc]

#Now we can read in all of the csv's files
#first with the BFFC
BFFC_metrics_dfs <- read_csv_files(BFFC_metrics_list)

BFFC_metrics <- do.call(rbind, BFFC_metrics_dfs)

#Second with ffc metrics
FFC_metrics_dfs <- read_csv_files(files_original_ffc)

FFC_metrics <- do.call(rbind, FFC_metrics_dfs)

#Now cycle through the names in the dataframes and make comaring viollin plots
cnames <- colnames(FFC_metrics)

comparison_violin_plot_print(metrics_1 = FFC_metrics, metrics_2 = BFFC_metrics, stream_class = "Class 6", data_title = "Class 6 metric comparison")
```


Make the figures for Class 7 

```{r}
#I

# Function to read CSV files into a list of data frames
read_csv_files <- function(files) {
  lapply(files, function(file) {
    read.csv(file)
  })
}

# Read files ending with "_Original Calculator_Metrics.csv"
files_original_ffc <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Updated Reference Gages Class 7", pattern = "_Original Calculator_Metrics.csv$", recursive = TRUE, full.names = TRUE)

# Read files ending with "_Metrics.csv"
files_metrics_bffc <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Updated Reference Gages Class 7", pattern = "_Metrics.csv$", recursive = TRUE, full.names = TRUE)

#Since both character list have the ffc metrics since they have the same pattern
BFFC_metrics_list <- files_metrics_bffc[!files_metrics_bffc %in% files_original_ffc]

#Now we can read in all of the csv's files
#first with the BFFC
BFFC_metrics_dfs <- read_csv_files(BFFC_metrics_list)

BFFC_metrics <- do.call(rbind, BFFC_metrics_dfs)

#Second with ffc metrics
FFC_metrics_dfs <- read_csv_files(files_original_ffc)

FFC_metrics <- do.call(rbind, FFC_metrics_dfs)

#Now cycle through the names in the dataframes and make comaring viollin plots
cnames <- colnames(FFC_metrics)

comparison_violin_plot_print(metrics_1 = FFC_metrics, metrics_2 = BFFC_metrics, stream_class = "Class 7", data_title = "Class 7 metric comparison")
```



Make the figures for Class 8

```{r}

# Read files ending with "_Original Calculator_Metrics.csv"
files_original_ffc <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Updated Reference Gages Class 8", pattern = "_Original Calculator_Metrics.csv$", recursive = TRUE, full.names = TRUE)

# Read files ending with "_Metrics.csv"
files_metrics_bffc <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Updated Reference Gages Class 8", pattern = "_Metrics.csv$", recursive = TRUE, full.names = TRUE)

#Since both character list have the ffc metrics since they have the same pattern
BFFC_metrics_list <- files_metrics_bffc[!files_metrics_bffc %in% files_original_ffc]

#Now we can read in all of the csv's files
#first with the BFFC
BFFC_metrics_dfs <- read_csv_files(BFFC_metrics_list)

BFFC_metrics <- do.call(rbind, BFFC_metrics_dfs)

#Second with ffc metrics
FFC_metrics_dfs <- read_csv_files(files_original_ffc)

FFC_metrics <- do.call(rbind, FFC_metrics_dfs)

#Now cycle through the names in the dataframes and make comaring viollin plots
cnames <- colnames(FFC_metrics)

comparison_violin_plot_print(metrics_1 = FFC_metrics, metrics_2 = BFFC_metrics, stream_class = "Class 8", data_title = "Class 8 metric comparison")
```



Make the figures for Class 9

```{r}

# Read files ending with "_Original Calculator_Metrics.csv"
files_original_ffc <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Updated Reference Gages Class 9", pattern = "_Original Calculator_Metrics.csv$", recursive = TRUE, full.names = TRUE)

# Read files ending with "_Metrics.csv"
files_metrics_bffc <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Updated Reference Gages Class 9", pattern = "_Metrics.csv$", recursive = TRUE, full.names = TRUE)

#Since both character list have the ffc metrics since they have the same pattern
BFFC_metrics_list <- files_metrics_bffc[!files_metrics_bffc %in% files_original_ffc]

#Now we can read in all of the csv's files
#first with the BFFC
BFFC_metrics_dfs <- read_csv_files(BFFC_metrics_list)

BFFC_metrics <- do.call(rbind, BFFC_metrics_dfs)

#Second with ffc metrics
FFC_metrics_dfs <- read_csv_files(files_original_ffc)

FFC_metrics <- do.call(rbind, FFC_metrics_dfs)

#Now cycle through the names in the dataframes and make comaring viollin plots
cnames <- colnames(FFC_metrics)

comparison_violin_plot_print(metrics_1 = FFC_metrics, metrics_2 = BFFC_metrics, stream_class = "Class 9", data_title = "Class 9 metric comparison")
```



Make the figures for all reference snow driven 

```{r}


# Read files ending with "_Original Calculator_Metrics.csv"
files_original_ffc_class1 <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Updated Reference Gages Class 1", pattern = "_Original Calculator_Metrics.csv$", recursive = TRUE, full.names = TRUE)

# Read files ending with "_Metrics.csv"
files_metrics_bffc_class1 <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Updated Reference Gages Class 1", pattern = "_Metrics.csv$", recursive = TRUE, full.names = TRUE)


# Read files ending with "_Original Calculator_Metrics.csv"
files_original_ffc_class9 <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Updated Reference Gages Class 9", pattern = "_Original Calculator_Metrics.csv$", recursive = TRUE, full.names = TRUE)


# Read files ending with "_Metrics.csv"
files_metrics_bffc_class9 <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Updated Reference Gages Class 9", pattern = "_Metrics.csv$", recursive = TRUE, full.names = TRUE)

ffc_files_snow <- c(files_original_ffc_class1,  files_original_ffc_class9)

bffc_files_snow <- c(files_metrics_bffc_class1 ,files_metrics_bffc_class9)

#Since both character list have the ffc metrics since they have the same pattern
BFFC_metrics_list_snow <- bffc_files_snow[!bffc_files_snow %in% ffc_files_snow]

#Now we can read in all of the csv's files
#first with the BFFC
BFFC_metrics_snow_dfs <- read_csv_files(BFFC_metrics_list_snow)

BFFC_metrics_snow <- do.call(rbind, BFFC_metrics_snow_dfs)

#Second with ffc metrics
FFC_metrics_snow_dfs <- read_csv_files(ffc_files_snow)

FFC_metrics_snow <- do.call(rbind, FFC_metrics_snow_dfs)

#Now cycle through the names in the dataframes and make comaring viollin plots
cnames <- colnames(FFC_metrics)

comparison_violin_plot_print(metrics_1 = FFC_metrics_snow, metrics_2 = BFFC_metrics_snow, stream_class = "Snow Driven Classes", data_title = "Snow Driven Classes metric comparison")
```


Make the figures for all reference rain driven 

```{r}


# Read files ending with "_Original Calculator_Metrics.csv"
files_original_ffc_class4 <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Updated Reference Gages Class 4", pattern = "_Original Calculator_Metrics.csv$", recursive = TRUE, full.names = TRUE)

# Read files ending with "_Metrics.csv"
files_metrics_bffc_class4 <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Updated Reference Gages Class 4", pattern = "_Metrics.csv$", recursive = TRUE, full.names = TRUE)


# Read files ending with "_Original Calculator_Metrics.csv"
files_original_ffc_class6 <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Updated Reference Gages Class 6", pattern = "_Original Calculator_Metrics.csv$", recursive = TRUE, full.names = TRUE)

# Read files ending with "_Metrics.csv"
files_metrics_bffc_class6 <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Updated Reference Gages Class 6", pattern = "_Metrics.csv$", recursive = TRUE, full.names = TRUE)

# Read files ending with "_Original Calculator_Metrics.csv"
files_original_ffc_class7 <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Updated Reference Gages Class 7", pattern = "_Original Calculator_Metrics.csv$", recursive = TRUE, full.names = TRUE)

# Read files ending with "_Metrics.csv"
files_metrics_bffc_class7 <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Updated Reference Gages Class 7", pattern = "_Metrics.csv$", recursive = TRUE, full.names = TRUE)

# Read files ending with "_Original Calculator_Metrics.csv"
files_original_ffc_class8 <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Updated Reference Gages Class 8", pattern = "_Original Calculator_Metrics.csv$", recursive = TRUE, full.names = TRUE)

# Read files ending with "_Metrics.csv"
files_metrics_bffc_class8 <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Updated Reference Gages Class 8", pattern = "_Metrics.csv$", recursive = TRUE, full.names = TRUE)

ffc_files_rain <- c(files_original_ffc_class4,  files_original_ffc_class6, files_original_ffc_class7,files_original_ffc_class8)

bffc_files_rain <- c(files_metrics_bffc_class4,  files_metrics_bffc_class6, files_metrics_bffc_class7,files_metrics_bffc_class8)

bffc_files_rain_sin_c7 <- c(files_metrics_bffc_class4,  files_metrics_bffc_class6 ,files_metrics_bffc_class8)
ffc_files_sin_rain_c7 <- c(files_original_ffc_class4,  files_original_ffc_class6,files_original_ffc_class8)

#Since both character list have the ffc metrics since they have the same pattern
BFFC_metrics_rain_list <- bffc_files_rain[!bffc_files_rain %in% ffc_files_rain]

#Since both character list have the ffc metrics since they have the same pattern
BFFC_metrics_rain_sinc7_list <- bffc_files_rain_sin_c7[!bffc_files_rain_sin_c7 %in% ffc_files_sin_rain_c7]

#Now for just the FER gages
BFFC_metrics_Class_7 <-files_metrics_bffc_class7[!files_metrics_bffc_class7 %in% files_original_ffc_class7]
BFFC_metrics_FER_dfs <- read_csv_files(BFFC_metrics_Class_7)
FFC_metrics_FER_dfs <- read_csv_files(files_original_ffc_class7)

#Now we can read in all of the csv's files
#first with the BFFC
BFFC_metrics_rain_dfs <- read_csv_files(BFFC_metrics_rain_list)

BFFC_metrics_rain <- do.call(rbind, BFFC_metrics_rain_dfs)

#and without class 7 
BFFC_metrics_rsc7_dfs <- read_csv_files(BFFC_metrics_rain_sinc7_list)

BFFC_metrics_rsc7 <- do.call(rbind, BFFC_metrics_rsc7_dfs)

#Second with ffc metrics
FFC_metrics_rain_dfs <- read_csv_files(ffc_files_rain)

FFC_metrics_rain <- do.call(rbind, FFC_metrics_rain_dfs)

#and without class 7
FFC_metrics_rsc7_dfs <- read_csv_files(ffc_files_sin_rain_c7)

FFC_metrics_rsc7 <- do.call(rbind, FFC_metrics_rsc7_dfs)

#Now cycle through the names in the dataframes and make comaring viollin plots
cnames <- colnames(FFC_metrics)

comparison_violin_plot_print(metrics_1 = FFC_metrics_rsc7, metrics_2 = BFFC_metrics_rsc7, stream_class = "Rain Driven Classes without FER", data_title = "Rain Driven Classes WO FER metric comparison ")
```


Make the figures for all reference mixed systems 

```{r}


# Read files ending with "_Original Calculator_Metrics.csv"
files_original_ffc_class5 <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Updated Reference Gages Class 5 11377100", pattern = "_Original Calculator_Metrics.csv$", recursive = TRUE, full.names = TRUE)

# Read files ending with "_Metrics.csv"
files_metrics_bffc_class5 <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Updated Reference Gages Class 5 11377100", pattern = "_Metrics.csv$", recursive = TRUE, full.names = TRUE)


# Read files ending with "_Original Calculator_Metrics.csv"
files_original_ffc_class2 <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Updated Reference Gages Class 2", pattern = "_Original Calculator_Metrics.csv$", recursive = TRUE, full.names = TRUE)

# Read files ending with "_Metrics.csv"
files_metrics_bffc_class2 <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Updated Reference Gages Class 2", pattern = "_Metrics.csv$", recursive = TRUE, full.names = TRUE)

# Read files ending with "_Original Calculator_Metrics.csv"
files_original_ffc_class3 <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Updated Reference Gages Class 3", pattern = "_Original Calculator_Metrics.csv$", recursive = TRUE, full.names = TRUE)

# Read files ending with "_Metrics.csv"
files_metrics_bffc_class3 <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Updated Reference Gages Class 3", pattern = "_Metrics.csv$", recursive = TRUE, full.names = TRUE)

ffc_files_mixed <- c(files_original_ffc_class5,  files_original_ffc_class2, files_original_ffc_class3)

bffc_files_mixed <- c(files_metrics_bffc_class5,  files_metrics_bffc_class2, files_metrics_bffc_class3)

#Since both character list have the ffc metrics since they have the same pattern
BFFC_metrics_list_mixed <- bffc_files_mixed[!bffc_files_mixed %in% ffc_files_mixed]

#Now we can read in all of the csv's files
#first with the BFFC
BFFC_metrics_mixed_dfs <- read_csv_files(BFFC_metrics_list_mixed)

BFFC_metrics_mixed <- do.call(rbind, BFFC_metrics_mixed_dfs)

#Second with ffc metrics
FFC_metrics_mixed_dfs <- read_csv_files(ffc_files_mixed)

FFC_metrics_mixed <- do.call(rbind, FFC_metrics_mixed_dfs)

#Now cycle through the names in the dataframes and make comaring viollin plots
cnames <- colnames(FFC_metrics)

comparison_violin_plot_print(metrics_1 = FFC_metrics_mixed, metrics_2 = BFFC_metrics_mixed, stream_class = "Mixed Classes", data_title = "Mixed Classes metric comparison")
```


#Make a figure looking at our highly altered gages


```{r}


# Read files ending with "_Original Calculator_Metrics.csv"
files_original_ffc_HA <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Highly Altered Gages", pattern = "_Original Calculator_Metrics.csv$", recursive = TRUE, full.names = TRUE)

# Read files ending with "_Metrics.csv"
files_metrics_bffc_HA <- list.files(path = "~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Highly Altered Gages", pattern = "_Metrics.csv$", recursive = TRUE, full.names = TRUE)

#Since both character list have the ffc metrics since they have the same pattern
BFFC_metrics_list_HA <- files_metrics_bffc_HA[!files_metrics_bffc_HA %in% files_original_ffc_HA]

#Now we can read in all of the csv's files
#first with the BFFC
BFFC_metrics_dfs_HA <- read_csv_files(BFFC_metrics_list_HA)

BFFC_metrics_HA <- do.call(rbind, BFFC_metrics_dfs_HA)

#Second with ffc metrics
FFC_metrics_dfs_HA <- read_csv_files(files_original_ffc_HA)

FFC_metrics_HA <- do.call(rbind, FFC_metrics_dfs_HA)

#Now cycle through the names in the dataframes and make comaring viollin plots
cnames <- colnames(FFC_metrics)

comparison_violin_plot_print(metrics_1 = FFC_metrics_HA, metrics_2 = BFFC_metrics_HA, stream_class = "Highly Altered Gages", data_title = "Highly Altered Gages metric comparison")

#figure out number NA's per row for the FFC DFs
na_count_ffc_HA <- lapply(FFC_metrics_dfs_HA, function(df) {
  # Select columns that do not start with "FA"
  df_filtered <- df[, !(grepl("^FA", names(df)) | grepl("^Peak", names(df)))] 
  total_rows <- nrow(df_filtered)
  if (total_rows > 0) {
    sum(is.na(df_filtered)) / total_rows
  } else {
    0  # Avoid division by zero
  }
})

#figure out number NA's per row for the BFFC DFs
na_count_bffc_HA <- lapply(BFFC_metrics_dfs_HA, function(df) {
  # Select columns that do not start with "FA"
  df_filtered <- df[, !(grepl("^FA", names(df)) | grepl("^Peak", names(df)))]
  
  total_rows <- nrow(df_filtered)
  if (total_rows > 0) {
    sum(is.na(df_filtered)) / total_rows
  } else {
    0  # Avoid division by zero
  }
})

#figure out number NA's per row for the BFFC In Snow
na_count_bffc_Snow <- lapply(BFFC_metrics_snow_dfs, function(df) {
  # Select columns that do not start with "FA"
  df_filtered <- df[, !(grepl("^FA", names(df)) | grepl("^Peak", names(df)))]  
  total_rows <- nrow(df_filtered)
  if (total_rows > 0) {
    sum(is.na(df_filtered)) / total_rows
  } else {
    0  # Avoid division by zero
  }
})

#and for the FFC In Snow
na_count_ffc_Snow <- lapply(FFC_metrics_snow_dfs, function(df) {
  # Select columns that do not start with "FA"
  df_filtered <- df[, !(grepl("^FA", names(df)) | grepl("^Peak", names(df)))] 
  total_rows <- nrow(df_filtered)
  if (total_rows > 0) {
    sum(is.na(df_filtered)) / total_rows
  } else {
    0  # Avoid division by zero
  }
})

#and for the FFC In rain without class 7
na_count_ffc_rain_WOc7 <- lapply(FFC_metrics_rsc7_dfs, function(df) {
  # Select columns that do not start with "FA"
  df_filtered <- df[, !(grepl("^FA", names(df)) | grepl("^Peak", names(df)))] 
  total_rows <- nrow(df_filtered)
  if (total_rows > 0) {
    sum(is.na(df_filtered)) / total_rows
  } else {
    0  # Avoid division by zero
  }
})

#figure out number NA's per row for the ain without class 7
na_count_bffc_rain_WOc7 <- lapply(BFFC_metrics_rsc7_dfs, function(df) {
  # Select columns that do not start with "FA"
  df_filtered <- df[, !(grepl("^FA", names(df)) | grepl("^Peak", names(df)))]  
  total_rows <- nrow(df_filtered)
  if (total_rows > 0) {
    sum(is.na(df_filtered)) / total_rows
  } else {
    0  # Avoid division by zero
  }
})

#and for the FFC class 7
na_count_ffc_class_7 <- lapply(FFC_metrics_FER_dfs, function(df) {
  # Select columns that do not start with "FA"
  df_filtered <- df[, !(grepl("^FA", names(df)) | grepl("^Peak", names(df)))] 
  total_rows <- nrow(df_filtered)
  if (total_rows > 0) {
    sum(is.na(df_filtered)) / total_rows
  } else {
    0  # Avoid division by zero
  }
})

#figure out number NA's per row for class 7
na_count_bffc_class_7 <- lapply(BFFC_metrics_FER_dfs, function(df) {
  # Select columns that do not start with "FA"
  df_filtered <- df[, !(grepl("^FA", names(df)) | grepl("^Peak", names(df)))]  
  total_rows <- nrow(df_filtered)
  if (total_rows > 0) {
    sum(is.na(df_filtered)) / total_rows
  } else {
    0  # Avoid division by zero
  }
})


#figure out number NA's per row for the BFFC In mixed sytems
na_count_bffc_mixed <- lapply(BFFC_metrics_mixed_dfs, function(df) {
  # Select columns that do not start with "FA"
  df_filtered <- df[, !(grepl("^FA", names(df)) | grepl("^Peak", names(df)))]  
  total_rows <- nrow(df_filtered)
  if (total_rows > 0) {
    sum(is.na(df_filtered)) / total_rows
  } else {
    0  # Avoid division by zero
  }
})

#and for the FFC In mixed
na_count_ffc_mixed <- lapply(FFC_metrics_mixed_dfs, function(df) {
  # Select columns that do not start with "FA"
  df_filtered <- df[, !(grepl("^FA", names(df)) | grepl("^Peak", names(df)))]
  total_rows <- nrow(df_filtered)
  if (total_rows > 0) {
    sum(is.na(df_filtered)) / total_rows
  } else {
    0  # Avoid division by zero
  }
})


# Convert the list to a dataframe for the ffc
na_count_ffc_df_HA <- data.frame( NA_Count = unlist(na_count_ffc_HA))
na_count_bffc_df_HA <- data.frame( NA_Count = unlist(na_count_bffc_HA))

na_count_ffc_df_c7 <- data.frame( NA_Count = unlist(na_count_ffc_class_7))
na_count_bffc_df_c7 <- data.frame( NA_Count = unlist(na_count_bffc_class_7))

na_count_ffc_df_Snow <- data.frame( NA_Count = unlist(na_count_ffc_Snow))
na_count_bffc_df_Snow <- data.frame( NA_Count = unlist(na_count_bffc_Snow))

na_count_ffc_df_Rain <- data.frame( NA_Count = unlist(na_count_ffc_rain_WOc7))
na_count_bffc_df_Rain <- data.frame( NA_Count = unlist(na_count_bffc_rain_WOc7))

na_count_ffc_df_mixed <- data.frame( NA_Count = unlist(na_count_ffc_mixed))
na_count_bffc_df_mixed <- data.frame( NA_Count = unlist(na_count_bffc_mixed))



    Violinplot_NA_Average <- ggplot() +
      geom_violin(aes(x = "FFC Highly Altered", y = as.numeric(na_count_ffc_df_HA$NA_Count)), fill = "green") +
      geom_boxplot(aes(x = "FFC Highly Altered", y = as.numeric(na_count_ffc_df_HA$NA_Count)), color = "darkgreen", alpha = 0.6) +
      geom_violin(aes(x = "FFC Snow", y = as.numeric(na_count_ffc_df_Snow$NA_Count)), fill = "green") +
      geom_boxplot(aes(x = "FFC Snow", y = as.numeric(na_count_ffc_df_Snow$NA_Count)), color = "darkgreen", alpha = 0.6) +
      geom_violin(aes(x = "FFC Rain", y = as.numeric(na_count_ffc_df_Rain$NA_Count)), fill = "green") +
      geom_boxplot(aes(x = "FFC Rain", y = as.numeric(na_count_ffc_df_Rain$NA_Count)), color = "darkgreen", alpha = 0.6) +
      geom_violin(aes(x = "FFC Mixed", y = as.numeric(na_count_ffc_df_mixed$NA_Count)), fill = "green") +
      geom_boxplot(aes(x = "FFC Mixed", y = as.numeric(na_count_ffc_df_mixed$NA_Count)), color = "darkgreen", alpha = 0.6) +
      geom_violin(aes(x = "FFC FER", y = as.numeric(na_count_ffc_df_c7$NA_Count)), fill = "green") +
      geom_boxplot(aes(x = "FFC FER", y = as.numeric(na_count_ffc_df_c7$NA_Count)), color = "darkgreen", alpha = 0.6) +
      
      geom_violin(aes(x = "BFFC Highly Altered", y = as.numeric(na_count_bffc_df_HA$NA_Count)), fill = 'blue') +
      geom_boxplot(aes(x = "BFFC Highly Altered", y = as.numeric(na_count_bffc_df_HA$NA_Count)), color = "darkblue", alpha = 0.6)+
      geom_violin(aes(x = "BFFC Snow", y = as.numeric(na_count_bffc_df_Snow$NA_Count)), fill = 'blue') +
      geom_boxplot(aes(x = "BFFC Snow", y = as.numeric(na_count_bffc_df_Snow$NA_Count)), color = "darkblue", alpha = 0.6)+
      geom_violin(aes(x = "BFFC Rain", y = as.numeric(na_count_bffc_df_Rain$NA_Count)), fill = 'blue') +
      geom_boxplot(aes(x = "BFFC Rain", y = as.numeric(na_count_bffc_df_Rain$NA_Count)), color = "darkblue", alpha = 0.6)+
      geom_violin(aes(x = "BFFC Mixed", y = as.numeric(na_count_bffc_df_mixed$NA_Count)), fill = 'blue') +
      geom_boxplot(aes(x = "BFFC Mixed", y = as.numeric(na_count_bffc_df_mixed$NA_Count)), color = "darkblue", alpha = 0.6)+
      geom_violin(aes(x = "BFFC FER", y = as.numeric(na_count_bffc_df_c7$NA_Count)), fill = 'blue') +
      geom_boxplot(aes(x = "BFFC FER", y = as.numeric(na_count_bffc_df_c7$NA_Count)), color = "darkblue", alpha = 0.6)
      
      
      Violinplot_NA_Average <- Violinplot_NA_Average +
      labs(x = "Flow Regimes", y = "Number of Non-Fall Related NA per Eater Year", title = paste("Number of Non-Fall Related NA per Year in Different Systems"))+
      scale_y_continuous(limits = c(0, 10), breaks = seq(0, 10, by = 2), minor_breaks = seq(0, 10, by = 1))+
      theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
    
    plot(Violinplot_NA_Average)

    ggsave(paste0("~/Desktop/School Stuff/UC Davis/Work/Alt_FFC/Alternate-Ruleset-FFC-BETA/Report Figures/","NA Comparison by WY",".png"), plot = Violinplot_NA_Average, device = "png")
  

#figure out number NA's per row for the FFC DFs
na_count_ffc_HA <- lapply(FFC_metrics_dfs, function(df) {
  # Select columns that do not start with "FA"
  df_filtered <- df[, !grepl("^FA", names(df))]
  df_filtered <- df_filtered[,!grepl("^Peak", names(df))]
  total_rows <- nrow(df_filtered)
  if (total_rows > 0) {
    sum(is.na(df_filtered)) / total_rows
  } else {
    0  # Avoid division by zero
  }
})

#figure out number NA's per row for the BFFC DFs
na_count_bffc_HA <- lapply(BFFC_metrics_dfs, function(df) {
  # Select columns that do not start with "FA"
  df_filtered <- df[, !grepl("^FA", names(df))]
  df_filtered <- df_filtered[,!grepl("^Peak", names(df))]
  total_rows <- nrow(df_filtered)
  if (total_rows > 0) {
    sum(is.na(df_filtered)) / total_rows
  } else {
    0  # Avoid division by zero
  }
})

    
    
```

```{r}

# Initialize a list to store the results
na_count_bffc <- list()

# Loop through each dataframe in BFFC_metrics_dfs
for (df in BFFC_metrics_dfs) {
  # Select columns that do not start with "FA"
  df_filtered <- df[, !grepl("^FA", names(df))]
  
  # Count NA values per row for filtered dataframe
  na_per_row <- rowSums(is.na(df_filtered))
  
  # Count number of rows with at least 4 NA values
  num_rows_with_4na <- sum(na_per_row >= 4)
  
  # Store the result
  na_count_bffc[[length(na_count_bffc) + 1]] <- num_rows_with_4na
}

# Convert the results to a dataframe
na_count_bffc_df <- data.frame(
  Dataframe = 1:length(BFFC_metrics_dfs),
  Rows_With_4NA = unlist(na_count_bffc)
)

# Print the resulting dataframe
print(na_count_bffc_df)


```
